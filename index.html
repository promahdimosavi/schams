<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پرداخت با Toncoin</title>
    <script src="https://cdn.jsdelivr.net/npm/tonweb/dist/tonweb.min.js"></script>
</head>
<body>
    <!-- دکمه برای ارسال درخواست پرداخت -->
    <button id="sendPaymentButton">ارسال پرداخت</button>

    <script>
        const isMainnet = true;

        // استفاده از Toncenter API برای ارتباط با بلاکچین TON
        const tonweb = isMainnet ? 
            new TonWeb(new TonWeb.HttpProvider('https://toncenter.com/api/v2/jsonRPC', {apiKey: 'YOUR_MAINNET_API_KEY'})) :
            new TonWeb(new TonWeb.HttpProvider('https://testnet.toncenter.com/api/v2/jsonRPC', {apiKey: 'YOUR_TESTNET_API_KEY'}));

        const MY_WALLET_ADDRESS = 'UQB7AhB4fP7SWtnfnIMcVUkwIgVLKqijlcpjNEPUVontys5I';

        // تابع برای تولید UUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0,
                    v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // ارسال درخواست پرداخت
        document.getElementById('sendPaymentButton').addEventListener('click', async () => {
            const uuid = generateUUID(); // تولید UUID جدید
            const amountInNano = 1000000000; // 1 Toncoin به نانو-Toncoins

            // ساخت deeplink برای باز کردن اپلیکیشن کیف پول با اطلاعات پرشده
            const deeplink = `ton://transfer/${MY_WALLET_ADDRESS}?amount=${amountInNano}&text=${uuid}`;

            // انتقال به deeplink در مرورگر یا اپلیکیشن کیف پول
            window.location.href = deeplink;

            console.log(`درخواست پرداخت با UUID ارسال شد: ${uuid}`);
        });

        // گوش دادن به تراکنش‌ها
        const onTransaction = async (tx) => {
            if (tx.in_msg.source && tx.out_msgs.length === 0) {
                if (tx.in_msg.msg_data && tx.in_msg.msg_data['@type'] !== 'msg.dataText') {
                    return;
                }

                const value = tx.in_msg.value; // مقدار در نانو-Toncoins
                const senderAddress = tx.in_msg.source; // آدرس فرستنده
                const payload = tx.in_msg.message; // پیام انتقال (که UUID است)

                // در اینجا شما می‌توانید پرداخت را در دیتابیس خود جستجو کرده و بررسی کنید که پردازش شده باشد یا نه
                console.log(`دریافت ${TonWeb.utils.fromNano(value)} TON از ${senderAddress} با پیام "${payload}"`);
            }
        };

        const accountSubscription = new TonWeb.AccountSubscription(tonweb, MY_WALLET_ADDRESS, 0, onTransaction);
        accountSubscription.start();
    </script>
</body>
</html>
